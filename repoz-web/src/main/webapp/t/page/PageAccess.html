<section class="windfury">

	<section class="main">
		<div class="accessMain">
			<h1>Access</h1>
			<div class="accessNew">
				<form action="#" class="">
					<input type="hidden" name="path" class="path" />
					<fieldset>
						<ul>
							<li><label>User: </label> <input type="text" name="user" class="user" /></li>
							<li><label>Pass: </label> <input type="text" name="pass" class="pass" /></li>
							<li><label>Type: </label> <select name="type">
									<option value="read">read</option>
									<option value="write">write</option>
							</select></li>
							<li><input type="button" value="Cancel" class="cancel" /><input type="submit" value="Add" /></li>
						</ul>
					</fieldset>
				</form>
			</div>
			<div class="accessQuery">
				<form action="#" class="">
					<fieldset>
						<ul>
							<li><label>Path: </label> <input type="text" name="path" class="path" /></li>
							<li><input type="submit" value="Query" /></li>
						</ul>
					</fieldset>
				</form>
				<div class="queryResult">
					<table>
						<thead>
							<tr>
								<th>path</th>
								<th>user</th>
								<th>pass</th>
								<th>type</th>
								<th>action</th>
							</tr>
						</thead>
						<tbody>
						</tbody>
					</table>
					<input type="button" value="Add" class="add" />
				</div>
			</div>
		</div>
	</section>

	<script type="text/javascript">
		(function($, wf) {
			var main = wf.text('.main');

			function open() {
				var path = $.querystring().get('path');
				var page = $(main());
				$('#wrapper').html(page);

				if (!path) {
					location = '#Access?path=/';
					return;
				}

				function query() {
					if (!path) {
						return false;
					}
					page.find('.queryResult tbody').html('');
					$.ajax({
						url : 'access',
						dataType : 'text',
						data : {
							path : path
						},
						success : function(rows) {
							rows = $.trim(rows);
							rows = rows.split('\n');
							for (var i = 0; $.oplt(i, rows.length); i++) {
								var row = rows[i];
								var args = row.split(/\s+/);
								var tr = $('<tr/>');
								page.find('.queryResult tbody').append(tr)
								$('<td/>').text(args[0]).appendTo(tr);
								$('<td/>').text(args[1]).appendTo(tr);
								$('<td/>').text(args[2]).appendTo(tr);
								$('<td/>').text(args[3]).appendTo(tr);
								$('<td><input type="button" value="Delete" class="delete" /><a class="go" href="#Access?path=' + args[0] + '">Go</a></td>').appendTo(tr);
								tr.data('repoz.access.user', args[1]);
								tr.data('repoz.access.path', args[0]);
							}
							page.find('.queryResult tbody .delete').click(function() {
								var path = $(this).closest('tr').data('repoz.access.path');
								var user = $(this).closest('tr').data('repoz.access.user');
								if (window.confirm('Delete ' + path + ' ' + user + '?')) {
									var url = 'access?path=' + path;
									if (user) {
										url += '&amp;user=' + user;
									}
									if (user || window.prompt('Type delete to confirm').toLowerCase() == 'delete') {
										$.ajax({
											type : 'DELETE',
											url : url,
											success : function() {
												query();
											}

										});
									}
								}
							});
							if (path == '/') {
								page.find('.queryResult tr > :eq(1)').hide();
								page.find('.queryResult tr > :eq(2)').hide();
								page.find('.queryResult tr > :eq(3)').hide();
							} else {
								page.find('.queryResult tbody .go').hide();
							}
						}
					});
				}
				if (path == '/') {
					page.find('.accessQuery .add').hide();
				} else {
					page.find('.accessQuery .add').show();
				}

				page.find('.accessNew').hide();
				page.find('.accessQuery').show();
				page.find('.accessQuery .path').val(path);
				page.find('.accessNew .path').val(path);
				page.find('.accessQuery .add').click(function() {
					page.find('.accessQuery').hide();
					page.find('.accessNew').show();
				});
				page.find('.accessNew .cancel').click(function() {
					page.find('.accessQuery').show();
					page.find('.accessNew').hide();
				});
				page.find('.accessQuery form').submit(function() {
					var obj = $(this).serializeObject();
					if (!obj.path) {
						return false;
					}
					location = '#Access?path=' + obj.path;
					return false;
				});
				page.find('.accessNew form').submit(function() {
					var obj = $(this).serializeObject();
					$.ajax({
						type : 'POST',
						url : 'access',
						data : obj,
						success : function() {
							page.find('.accessNew').hide();
							page.find('.accessQuery').show();
							query();
						}
					});
					return false;
				});
				query();
			}

			wf.def({
				open : open
			});
		})(jQuery, windfury);
	</script>

</section>